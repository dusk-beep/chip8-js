(()=>{function d(){return{windowWidth:64,windowHeight:32,forgroundColor:"#33ff66",backgroundColor:"black",scaleFactor:5}}var l=[240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128];var r=class{state;entryPoint=512;machine;inst;config;win;isSoundPlaying=!1;keypad;context;oscillator=null;constructor(i=2,t,s){if(this.setupInputListeners(),this.context=new window.AudioContext,!this.context)throw new Error("no AudioContext");this.state=i,this.win=s,this.keypad=new Array(16).fill(!1),this.machine={ram:new Uint8Array(4096),display:new Array(64*32).fill(!1),stack:new Uint16Array(12),pc:this.entryPoint,V:new Uint8Array(16),I:0,soundTimer:0,delayTimer:0,stackPtr:-1},this.inst={opcode:0,NN:0,N:0,NNN:0,X:0,Y:0},this.config=t}draw(){let{windowWidth:i,windowHeight:t,scaleFactor:s,forgroundColor:e,backgroundColor:a}=this.config,h=this.win.ctx;h.fillStyle=a,h.fillRect(0,0,i*s,t*s);for(let n=0;n<this.machine.display.length;n++){let o=n%i*s,p=Math.floor(n/i)*s;this.machine.display[n]&&(h.fillStyle=e,h.fillRect(o,p,s,s))}}emulateTimers(){this.machine.soundTimer>0?(this.machine.soundTimer--,this.isSoundPlaying||this.startSound()):this.stopSound(),this.machine.delayTimer>0&&this.machine.delayTimer--}startSound(){this.oscillator===null&&(this.oscillator=this.context.createOscillator(),this.oscillator.type="square",this.oscillator.frequency.setValueAtTime(440,this.context.currentTime),this.oscillator.connect(this.context.destination),this.oscillator.start())}stopSound(){this.oscillator!==null&&(this.oscillator.stop(),this.oscillator=null)}load(i){for(let t=0;t<l.length;t++){let s=l[t];s&&(this.machine.ram[t]=s)}for(let t=0;t<i.data.length;t++)this.machine.ram[this.entryPoint+2*t]=i.data[t]>>8,this.machine.ram[this.entryPoint+2*t+1]=i.data[t]&255;this.machine.pc=this.entryPoint}debug(){this.inst.opcode=this._fetch(),this.inst.NNN=this.inst.opcode&4095,this.inst.NN=this.inst.opcode&255,this.inst.N=this.inst.opcode&15,this.inst.X=this.inst.opcode>>8&15,this.inst.Y=this.inst.opcode>>4&15;let i="";switch(this.inst.opcode>>12&15){case 0:this.inst.NN==224?i="cleared the screen":this.inst.NN==238&&(i=`decrement stackptr return to ${this.machine.stack[this.machine.stackPtr]} `);break;case 1:i=`move pc from ${this.machine.pc.toString(16)} to ${this.inst.NNN.toString(16)}`;break;case 2:i=`incrmenet stackptr and jump to nnn ${this.machine.stackPtr} `;break;case 3:i=`skip next instruction if ${this.machine.V[this.inst.X]} == ${this.inst.NN}`;break;case 4:i=`skip next instruction if ${this.machine.V[this.inst.X]} != ${this.inst.NN}`;break;case 5:i=`skip next instruction if ${this.machine.V[this.inst.X]} == ${this.machine.V[this.inst.Y]}`;break;case 6:i=`sets  VX  to ${this.inst.NN.toString(16)}`;break;case 7:i=`adds ${this.inst.NN} to ${this.machine.V[this.inst.X]} `;break;case 8:this.inst.N==0?i="add Vx with Vy":this.inst.N==1?i="or Vx with Vy":this.inst.N==2?i="and Vx with Vy":this.inst.N==3?i="xor Vx with Vy":this.inst.N==4?i="add Vx with Vy":this.inst.N==5?i="sub Vx with Vy":this.inst.N==6?i="shift Vx by 1 right":this.inst.N==7?i="vx = vy-vx":this.inst.N==14&&(i="shift Vx by 1 left");break;case 9:i=`skip next instruction if ${this.machine.V[this.inst.X]} != ${this.machine.V[this.inst.Y]}`;break;case 10:i=`sets I to ${this.inst.NNN}`;break;case 13:i=`draw from ${this.machine.V[this.inst.X].toString(16)},${this.machine.V[this.inst.Y].toString(16)}: ${this.inst.N.toString(16)} byte long sprite `;break;default:break}console.log(`${this.inst.opcode.toString(16)} : ${this.machine.pc.toString(16)} :${i} `)}emulate_instruction(){switch(this.inst.opcode=this._fetch(),this.debug(),this._increment_pc(),this.inst.NNN=this.inst.opcode&4095,this.inst.NN=this.inst.opcode&255,this.inst.N=this.inst.opcode&15,this.inst.X=this.inst.opcode>>8&15,this.inst.Y=this.inst.opcode>>4&15,this.inst.opcode>>12&15){case 0:this.inst.NN==224?this.machine.display=new Array(64*32).fill(!1):this.inst.NN==238&&(this.machine.pc=this.machine.stack[this.machine.stackPtr--]);break;case 1:this.machine.pc=this.inst.NNN;break;case 2:this.machine.stack[++this.machine.stackPtr]=this.machine.pc,this.machine.pc=this.inst.NNN;break;case 3:this.machine.V[this.inst.X]==this.inst.NN&&this._increment_pc();break;case 4:this.machine.V[this.inst.X]!=this.inst.NN&&this._increment_pc();break;case 5:this.machine.V[this.inst.X]==this.machine.V[this.inst.Y]&&this._increment_pc();break;case 6:this.machine.V[this.inst.X]=this.inst.NN;break;case 7:this.machine.V[this.inst.X]+=this.inst.NN;break;case 8:if(this.inst.N==0)this.machine.V[this.inst.X]=this.machine.V[this.inst.Y];else if(this.inst.N==1)this.machine.V[this.inst.X]|=this.machine.V[this.inst.Y];else if(this.inst.N==2)this.machine.V[this.inst.X]&=this.machine.V[this.inst.Y];else if(this.inst.N==3)this.machine.V[this.inst.X]^=this.machine.V[this.inst.Y];else if(this.inst.N==4){let e=+(this.machine.V[this.inst.X]+this.machine.V[this.inst.Y]>255);this.machine.V[this.inst.X]+=this.machine.V[this.inst.Y],this.machine.V[15]=e}else if(this.inst.N==5){let e=this.machine.V[this.inst.Y]>=this.machine.V[this.inst.X];this.machine.V[this.inst.X]-=this.machine.V[this.inst.Y],this.machine.V[15]=Number(e)}else if(this.inst.N==6)this.machine.V[15]=this.machine.V[this.inst.X]&1,this.machine.V[this.inst.X]>>=1;else if(this.inst.N==7){let e=this.machine.V[this.inst.Y]>=this.machine.V[this.inst.X];this.machine.V[this.inst.X]=this.machine.V[this.inst.Y]-this.machine.V[this.inst.X],this.machine.V[15]=Number(e)}else this.inst.N==14&&(this.machine.V[15]=(this.machine.V[this.inst.X]&128)>>7,this.machine.V[this.inst.X]<<=1);break;case 9:this.machine.V[this.inst.X]!=this.machine.V[this.inst.Y]&&this._increment_pc();break;case 10:this.machine.I=this.inst.NNN;break;case 11:this.machine.pc=this.machine.V[0]+this.inst.NNN;break;case 12:this.machine.V[this.inst.X]=Math.floor(Math.random()*255)&this.inst.NN;break;case 13:let i=this.machine.V[this.inst.X]%this.config.windowWidth,t=i,s=this.machine.V[this.inst.Y]%this.config.windowHeight;this.machine.V[15]=0;for(let e=0;e<this.inst.N;e++){let a=this.machine.ram[this.machine.I+e];i=t;for(let h=7;h>=0;h--){let n=this.machine.display[s*this.config.windowWidth+i],o=a&1<<h?1:0;if(n&&o&&(this.machine.V[15]=1),this.machine.display[s*this.config.windowWidth+i]=!!(Number(this.machine.display[s*this.config.windowWidth+i])^(o?1:0)),++i>=this.config.windowWidth)break}if(++s>=this.config.windowHeight)break}this.draw();break;case 14:this.inst.NN==158?this.keypad[this.machine.V[this.inst.X]]&&this._increment_pc():this.inst.NN==161&&(this.keypad[this.machine.V[this.inst.X]]||this._increment_pc());break;case 15:switch(this.inst.NN){case 7:this.machine.V[this.inst.X]=this.machine.delayTimer;break;case 10:let e=!1,a=255;for(let n=0;n<this.keypad.length;n++)if(a=255,this.keypad[n]){a=n,e=!0;break}e?this.keypad[a]?this.machine.pc-=2:this.machine.V[this.inst.X]=a:this.machine.pc-=2;break;case 30:this.machine.I+=this.machine.V[this.inst.X];break;case 21:this.machine.delayTimer=this.machine.V[this.inst.X];break;case 24:this.machine.soundTimer=this.machine.V[this.inst.X];break;case 41:this.machine.I=this.machine.V[this.inst.X]*5;break;case 51:let h=this.machine.V[this.inst.X];this.machine.ram[this.machine.I+2]=h%10,h/=10,this.machine.ram[this.machine.I+1]=h%10,h/=10,this.machine.ram[this.machine.I]=h%10,h/=10;break;case 85:for(let n=0;n<=this.machine.V[this.inst.X];n++)this.machine.ram[this.machine.I+n]=this.machine.V[n];break;case 101:for(let n=0;n<=this.machine.V[this.inst.X];n++)this.machine.V[n]=this.machine.ram[this.machine.I+n];break;default:throw this.state=0,console.log("Setting state to Quit due to unimplemented opcode: ",this.inst.opcode.toString(16)),new Error("unimplemented opcode")}break;default:throw this.state=0,console.log("Setting state to Quit due to unimplemented opcode: ",this.inst.opcode.toString(16)),new Error("unimplemented opcode")}}_increment_pc(){this.machine.pc+=2}setupInputListeners(){let i=document.querySelectorAll("button");if(i.length===0)return;let t=(s,e,a)=>{this.handle_input(s,e)};i.forEach(s=>{s.addEventListener("touchstart",e=>t(s,"keydown",e)),s.addEventListener("touchend",e=>t(s,"keyup",e)),s.addEventListener("touchcancel",e=>t(s,"keyup",e))})}handle_input(i,t){if(!i)return;let s={1:1,2:2,3:3,4:12,q:4,w:5,e:6,r:13,a:7,s:8,d:9,f:14,z:10,x:0,c:11,v:15},e=i.textContent?.toLowerCase();if(e){let a=s[e];a!==void 0&&(this.keypad[a]=t==="keydown")}}_fetch(){if(this.machine.pc>4094)throw this.state=0,new Error("memory out of bounds");return this.machine.ram[this.machine.pc]<<8|this.machine.ram[this.machine.pc+1]<<0}};var m=class{canvas;ctx;width;height;constructor(i){if(this.canvas=document.querySelector(".canvas"),!this.canvas)throw Error("no canvas");this.canvas.width=this.width=i.windowWidth*i.scaleFactor,this.canvas.height=this.height=i.windowHeight*i.scaleFactor,this.ctx=this.canvas.getContext("2d")}clearscreen(){this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.width,this.height)}};var x=class{data;constructor(i){this.data=[];for(let t=0;t<i.length;t+=2)this.data.push(i[t]<<8|i[t+1]<<0)}dump(){let i=[];for(let t=0;t<this.data.length;t+=8){let s=(t*2).toString(16).padStart(6,"0"),a=this.data.slice(t,t+8).map(h=>h.toString(16).padStart(4,"0")).join(" ");i.push(`${s} ${a}`)}return i.join(`
`)}};function f(c){let i=d(),t=new Uint8Array(c),s=new x(t);console.log(s.dump());let e=new m(i);e.clearscreen();let a=new r(2,i,e);a.load(s);let h=0;a.draw();function n(){if(h++,a.state!==0){try{a.emulate_instruction()}catch(o){console.log(o)}h%5==0&&(a.emulateTimers(),h=0)}setTimeout(n,3)}return n(),0}async function N(){let c=document.getElementById("select").value;try{let t=await(await fetch(`./rom/${c}`)).arrayBuffer();if(f(t))throw Error("unexpected error occured in main loop")}catch(i){console.log(i)}}console.log("emtry");var u=document.querySelector("select");if(!u)throw Error("no rom selected");u.addEventListener("change",N);})();
//# sourceMappingURL=web.js.map
